@page "/pets"
@using Microsoft.AspNetCore.Components.QuickGrid
@using PawPal.Domain
@using PawPal.Repositories
@inject IPetRepository PetRepository

<PageTitle>Index</PageTitle>

<h1>Adoptable Pets</h1>

<p>
    <a href="pets/create" class="btn btn-primary">Create New</a>
</p>

@if (petsQueryable == null)
{
    <p><em>Loading pets...</em></p>
}
else
{
    <QuickGrid Class="table table-striped" Items="petsQueryable" Pagination="pagination">
        <TemplateColumn Title="Photo">
            @if (!string.IsNullOrEmpty(context.ImageUrl))
            {
                <img src="@context.ImageUrl" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px;" />
            }
            else
            {
                <span>No Image</span>
            }
        </TemplateColumn>

        <PropertyColumn Property="pet => pet.Name" Sortable="true" />
        <PropertyColumn Property="pet => pet.Breed" Sortable="true" />
        <PropertyColumn Property="pet => pet.Age" Sortable="true" />
        <PropertyColumn Property="pet => pet.Size" Sortable="true" />

        <TemplateColumn Title="Status" Sortable="true">
            @if (context.IsAdopted)
            {
                <span class="badge bg-danger">Adopted</span>
            }
            else
            {
                <span class="badge bg-success">Available</span>
            }
        </TemplateColumn>

        <TemplateColumn Title="Actions">
            <a href="@($"pets/details?id={context.Id}")">Details</a> |
            <a href="@($"pets/edit?id={context.Id}")">Edit</a> |
            <a href="@($"pets/delete?id={context.Id}")">Delete</a>
        </TemplateColumn>
    </QuickGrid>

    <Paginator State="pagination" />
}

@code {
    private IQueryable<Pet>? petsQueryable;
    private PaginationState pagination = new PaginationState { ItemsPerPage = 10 };

    protected override async Task OnInitializedAsync()
    {
        // YIXIANG LOGIC: Fetch from Repository, convert to Queryable for QuickGrid
        var petList = await PetRepository.GetAllPetsAsync();
        petsQueryable = petList.AsQueryable();
    }
}
