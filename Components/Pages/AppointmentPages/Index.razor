@page "/appointments"
@using Microsoft.AspNetCore.Components.QuickGrid
@using PawPal.Domain
@using PawPal.Repositories
@using Microsoft.AspNetCore.Authorization
@inject IAppointmentRepository AppointmentRepository
@inject IShelterRepository ShelterRepository
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Appointments</PageTitle>

<h1>Appointments</h1>

<div class="mb-3">
    <a href="appointments/create" class="btn btn-primary">Book Appointment</a>
</div>

@if (appointmentsQueryable == null)
{
    <p><em>Loading appointments...</em></p>
}
else if (!appointmentsQueryable.Any())
{
    <div class="alert alert-info">No appointments found.</div>
}
else
{
    <QuickGrid Class="table table-striped" Items="appointmentsQueryable" Pagination="pagination">
        <PropertyColumn Property="a => a.AppointmentDate" Title="Date" Format="g" Sortable="true" />

        <TemplateColumn Title="Pet">
            <a href="/pets/details?id=@context.PetId">@context.Pet?.Name</a>
        </TemplateColumn>

        <PropertyColumn Property="a => a.Status" Sortable="true" />
        <PropertyColumn Property="a => a.Remarks" />

        <TemplateColumn Title="Actions">
            <a href="@($"appointments/details?id={context.Id}")">Details</a>
        </TemplateColumn>
    </QuickGrid>

    <Paginator State="pagination" />
}

@code {
    private IQueryable<Appointment>? appointmentsQueryable;
    private PaginationState pagination = new PaginationState { ItemsPerPage = 10 };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;

        if (userId == null) return;

        IEnumerable<Appointment> rawList = new List<Appointment>();

        // 1. ADMIN: See All
        if (user.IsInRole("Admin"))
        {
            rawList = await AppointmentRepository.GetAllAppointmentsAsync();
        }
        // 2. SHELTER OWNER: See only appointments for MY pets
        else
        {
            // Check if this user owns a shelter
            var myShelter = await ShelterRepository.GetShelterByUserIdAsync(userId);

            if (myShelter != null)
            {
                // Load appointments for this shelter's pets
                rawList = await AppointmentRepository.GetAppointmentsByShelterIdAsync(myShelter.Id);
            }
            // 3. ADOPTER: See only MY bookings
            else
            {
                rawList = await AppointmentRepository.GetAppointmentsByUserIdAsync(userId);
            }
        }

        appointmentsQueryable = rawList.AsQueryable();
    }
}