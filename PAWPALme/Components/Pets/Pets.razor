@page "/pets"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@inject IPetRepository PetRepo
@inject NavigationManager Nav

<PageTitle>Browse Pets | PawPal</PageTitle>

<div class="container py-4">

    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="neumorph-bar d-flex gap-3 align-items-center p-3">
                <i class="bi bi-search text-primary fs-4 ms-2"></i>

                <input type="text" class="form-input"
                       placeholder="Search by name, breed..."
                       @bind="SearchTerm"
                       @bind:event="oninput"
                       @onkeyup="FilterPets" />

                <select class="form-input w-25" @onchange="OnSpeciesChanged">
                    <option value="">All Species</option>
                    @foreach (var species in _speciesList)
                    {
                        <option value="@species">@species</option>
                    }
                </select>
            </div>
        </div>
    </div>

    @if (_filteredPets == null)
    {
        <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else if (!_filteredPets.Any())
    {
        <div class="text-center py-5 text-muted">
            <i class="bi bi-emoji-frown fs-1"></i>
            <p class="mt-3">No companions found matching your criteria.</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var pet in _filteredPets)
            {
                <div class="col-md-4 col-sm-6 col-lg-3">
                    <div class="pet-liquid-card h-100">
                        <div class="img-container">
                            @if (!string.IsNullOrEmpty(pet.ImageUrl))
                            {
                                <img src="@pet.ImageUrl" alt="@pet.Name" />
                            }
                            else
                            {
                                <div class="placeholder-img">
                                    <i class="bi bi-camera"></i>
                                </div>
                            }

                            <span class="status-badge @(pet.Status == PetStatus.Available ? "bg-success" : "bg-secondary")">
                                @pet.Status
                            </span>
                        </div>

                        <div class="card-body mt-3 text-center">
                            <h5 class="fw-bold mb-1">@pet.Name</h5>
                            <p class="text-muted small mb-3">@pet.Breed • @pet.Age yrs</p>

                            <a href="pet/@pet.Id" class="liquid-btn text-decoration-none d-block py-2">
                                Meet Me
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private IEnumerable<Pet>? _allPets;
    private IEnumerable<Pet>? _filteredPets;

    // Search State
    private string SearchTerm { get; set; } = "";
    private string? SelectedSpecies { get; set; }

    // Hardcoded list since Species is a string in your DB
    private List<string> _speciesList = new() { "Dog", "Cat", "Rabbit", "Bird", "Other" };

    protected override async Task OnInitializedAsync()
    {
        _allPets = await PetRepo.GetAllAsync();
        _filteredPets = _allPets;
    }

    private void FilterPets()
    {
        _filteredPets = _allPets;

        // 1. Text Search
        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            _filteredPets = _filteredPets.Where(p =>
                (p.Name != null && p.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (p.Breed != null && p.Breed.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase))
            );
        }

        // 2. Species Filter (String comparison)
        if (!string.IsNullOrEmpty(SelectedSpecies))
        {
            _filteredPets = _filteredPets.Where(p => p.Species.Equals(SelectedSpecies, StringComparison.OrdinalIgnoreCase));
        }
    }

    private void OnSpeciesChanged(ChangeEventArgs e)
    {
        SelectedSpecies = e.Value?.ToString();
        FilterPets();
    }
}