@page "/book-appointment/{PetId:int}"
@using PAWPALme.Models
@using PAWPALme.Repositories
@using PAWPALme.Enums
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@inject IAppointmentRepository ApptRepo
@inject IPetRepository PetRepo
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager

<PageTitle>Book a Visit</PageTitle>

<div class="container mt-4" style="max-width: 600px;">
    <div class="card shadow border-success">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">Meet @petName</h4>
        </div>
        <div class="card-body">
            <p class="text-muted">Schedule a time to visit this pet at the shelter.</p>

            @* FIX: Added FormName and bound to a single InputModel *@
            <EditForm Model="Input" OnValidSubmit="SaveAppointment" FormName="book-appointment">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-3">
                    <label class="form-label">Preferred Date</label>
                    <InputDate class="form-control" @bind-Value="Input.Date" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Preferred Time</label>
                    <input type="time" class="form-control" @bind="Input.Time" />
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Your Name</label>
                        <InputText class="form-control" @bind-Value="Input.ApplicantName" placeholder="Required" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="Input.ApplicantEmail" placeholder="Required" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <InputTextArea class="form-control" @bind-Value="Input.Notes" rows="3" />
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a href="pets" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-success">Confirm Booking</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public int PetId { get; set; }

    [SupplyParameterFromForm]
    private BookingInputModel Input { get; set; } = new();

    private string petName = "your new friend";
    private int shelterId;

    protected override async Task OnInitializedAsync()
    {
        // Load Pet Details (Visuals only)
        var pet = await PetRepo.GetByIdAsync(PetId);
        if (pet != null)
        {
            petName = pet.Name;
            shelterId = pet.ShelterId;
        }
        else
        {
            // Handle invalid pet ID
            Nav.NavigateTo("pets");
            return;
        }

        // Only pre-fill if this is a fresh GET request (not a POST back)
        if (Input.Date == default)
        {
            Input.Date = DateTime.Now.AddDays(1);
            Input.Time = new DateTime(1, 1, 1, 10, 0, 0); // Default 10:00 AM

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated ?? false)
            {
                Input.ApplicantName = user.FindFirst("FullName")?.Value ?? user.Identity.Name ?? "";
                Input.ApplicantEmail = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "";
            }
        }
    }
    // ... inside the @code block ...

    private async Task SaveAppointment()
    {
        // 1. Get Current User ID
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        var userId = user?.Id;

        // 2. Create the Application Stub
        var appStub = new AdoptionApplication
        {
            ApplicantName = Input.ApplicantName,
            ApplicantEmail = Input.ApplicantEmail,
            UserId = userId,
            PetId = PetId,
            ApplicationDate = DateTime.Now,
            Status = ApplicationStatus.Pending
        };

        // 3. Create the Appointment AND LINK THE APPLICATION
        var appointment = new Appointment
        {
            AppointmentDate = Input.Date,
            AppointmentTime = Input.Time.TimeOfDay,
            Notes = Input.Notes,
            Status = AppointmentStatus.Pending,
            PetId = PetId,
            ShelterId = shelterId,
            AdopterUserId = userId,

            // FIX: This links the two objects so they save together!
            AdoptionApplication = appStub
        };

        await ApptRepo.AddAsync(appointment);
        Nav.NavigateTo("my-appointments");
    }

    // DTO for the Form
    public class BookingInputModel
    {
        [Required]
        public DateTime Date { get; set; }

        [Required]
        public DateTime Time { get; set; }

        [Required]
        public string ApplicantName { get; set; } = "";

        [Required]
        [EmailAddress]
        public string ApplicantEmail { get; set; } = "";

        public string? Notes { get; set; }
    }
}