@page "/shelter/appointments"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using PAWPALme.Models
@using PAWPALme.Data
@using PAWPALme.Repositories
@using PAWPALme.Enums
@attribute [Authorize(Roles = "Shelter")]
@inject IAppointmentRepository ApptRepo
@inject IShelterRepository ShelterRepo 
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4">
    <h3>Appointment Requests</h3>

    @if (appointments == null)
    {
        <div class="spinner-border text-primary" role="status"></div>
    }
    else if (!appointments.Any())
    {
        <div class="alert alert-info">No pending appointments.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table align-middle table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Requested Date</th>
                        <th>Applicant</th>
                        <th>Pet</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var appt in appointments)
                    {
                        <tr>
                            <td>
                                <div>@appt.AppointmentDate.ToShortDateString()</div>
                                <small class="text-muted">@appt.AppointmentTime.ToString(@"hh\:mm")</small>
                            </td>
                            <td>
                                <strong>@(appt.AdoptionApplication?.ApplicantName ?? "Unknown")</strong>
                                <br />
                                <button class="btn btn-link btn-sm p-0" @onclick="() => ViewDetails(appt)">View Details</button>
                            </td>
                            <td>@appt.Pet?.Name</td>
                            <td>
                                <span class="badge @GetBadgeClass(appt.Status)">@appt.Status</span>
                            </td>
                            <td>
                                @if (appt.Status == AppointmentStatus.Pending)
                                {
                                    @* CHANGED: Open Modal instead of saving immediately *@
                                    <button class="btn btn-sm btn-success me-1" @onclick="() => OpenConfirmModal(appt)">Approve</button>
                                    
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => UpdateStatus(appt, AppointmentStatus.Cancelled)">Deny</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@* --- DETAILS MODAL (Read Only) --- *@
@if (selectedAppointment != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Application Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseDetails"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Applicant:</strong> @(selectedAppointment.AdoptionApplication?.ApplicantName ?? "N/A")</p>
                    <p><strong>Email:</strong> @(selectedAppointment.AdoptionApplication?.ApplicantEmail ?? "N/A")</p>
                    <hr />
                    <p><strong>Interest In:</strong> @(selectedAppointment.Pet?.Name)</p>
                    <p><strong>Notes from User:</strong></p>
                    <div class="p-3 bg-light rounded">
                        @(string.IsNullOrWhiteSpace(selectedAppointment.Notes) ? "No notes provided." : selectedAppointment.Notes)
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetails">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@* --- CONFIRMATION MODAL (Editable Date/Time) --- *@
@if (confirmingAppointment != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Confirm Appointment</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseConfirmModal"></button>
                </div>
                <div class="modal-body">
                    <p>Please finalize the date and time for this visit.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Confirmed Date</label>
                        <input type="date" class="form-control" @bind="confirmDate" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Confirmed Time</label>
                        <input type="time" class="form-control" @bind="confirmTime" />
                    </div>

                    <div class="alert alert-light border">
                        <i class="bi bi-geo-alt-fill text-danger"></i> <strong>Location:</strong><br/>
                        @currentShelterAddress
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseConfirmModal">Cancel</button>
                    <button type="button" class="btn btn-success" @onclick="FinalizeApproval">Send Confirmation</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private IEnumerable<Appointment>? appointments;
    private ApplicationUser? currentUser;
    
    // Modals state
    private Appointment? selectedAppointment; 
    private Appointment? confirmingAppointment;
    
    // Confirmation Form Data
    private DateTime confirmDate;
    private DateTime confirmTime;
    private string currentShelterAddress = "Loading...";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUser = await UserManager.GetUserAsync(authState.User);

        if (currentUser?.ShelterId != null)
        {
            appointments = await ApptRepo.GetByShelterIdAsync(currentUser.ShelterId.Value);
            
            // Fetch shelter address once for the UI
            var shelter = await ShelterRepo.GetByIdAsync(currentUser.ShelterId.Value);
            currentShelterAddress = shelter?.Address ?? "Address not found";
        }
    }

    // 1. Open the Approval Modal
    private void OpenConfirmModal(Appointment appt)
    {
        confirmingAppointment = appt;
        // Pre-fill with the user's requested time
        confirmDate = appt.AppointmentDate;
        confirmTime = DateTime.Today.Add(appt.AppointmentTime); 
    }

    private void CloseConfirmModal()
    {
        confirmingAppointment = null;
    }

    // 2. Actually Save the Approval
    private async Task FinalizeApproval()
    {
        if (confirmingAppointment != null)
        {
            // Update values from the modal inputs
            confirmingAppointment.AppointmentDate = confirmDate;
            confirmingAppointment.AppointmentTime = confirmTime.TimeOfDay;
            confirmingAppointment.Status = AppointmentStatus.Confirmed;

            await ApptRepo.UpdateAsync(confirmingAppointment);
            
            // Refresh list
            if (currentUser?.ShelterId != null)
            {
                appointments = await ApptRepo.GetByShelterIdAsync(currentUser.ShelterId.Value);
            }
            confirmingAppointment = null;
        }
    }

    // Standard Update (for Deny)
    private async Task UpdateStatus(Appointment appt, AppointmentStatus status)
    {
        appt.Status = status;
        await ApptRepo.UpdateAsync(appt);

        if (currentUser?.ShelterId != null)
        {
            appointments = await ApptRepo.GetByShelterIdAsync(currentUser.ShelterId.Value);
        }
    }

    private void ViewDetails(Appointment appt)
    {
        selectedAppointment = appt;
    }

    private void CloseDetails()
    {
        selectedAppointment = null;
    }

    private string GetBadgeClass(AppointmentStatus status) => status switch
    {
        AppointmentStatus.Confirmed => "bg-success",
        AppointmentStatus.Cancelled => "bg-danger",
        AppointmentStatus.Pending => "bg-warning text-dark",
        _ => "bg-secondary"
    };
}