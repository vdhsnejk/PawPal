@page "/book-appointment/{PetId:int}"
@using PAWPALme.Models
@using PAWPALme.Services
@inject AppointmentService ApptService
@inject PetService PetService
@inject NavigationManager Nav

<PageTitle>Book a Visit</PageTitle>

<div class="container mt-4" style="max-width: 600px;">
    <div class="card shadow border-success">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">Meet @petName</h4>
        </div>
        <div class="card-body">
            <p class="text-muted">Schedule a time to visit this pet at the shelter.</p>

            <EditForm Model="appointment" OnValidSubmit="SaveAppointment" FormName="BookingForm">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-3">
                    <label class="form-label">Preferred Date & Time</label>
                    <InputDate Type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="appointment.AppointmentDate" />
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Your Name</label>
                        <InputText class="form-control" @bind-Value="appointment.AdopterName" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="appointment.AdopterEmail" />
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a href="/pets" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-success">Confirm Booking</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public int PetId { get; set; }

    [SupplyParameterFromForm]
    public Appointment appointment { get; set; } = new();

    private string petName = "your new friend";

    protected override async Task OnInitializedAsync()
    {
        // 1. Get Pet Name for display
        var pet = await PetService.GetPetByIdAsync(PetId);
        if (pet != null)
        {
            petName = pet.Name;
            appointment.PetId = pet.Id; // Link the appointment to this pet
        }

        // 2. Set default date to tomorrow
        if (appointment.AppointmentDate == default)
            appointment.AppointmentDate = DateTime.Now.AddDays(1).Date.AddHours(10);
    }

    private async Task SaveAppointment()
    {
        await ApptService.AddAppointmentAsync(appointment);
        Nav.NavigateTo("/appointments"); // Redirect to "My Appointments"
    }
}