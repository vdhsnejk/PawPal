@page "/admin/applications/{Id:int}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Administrator")]
@rendermode InteractiveServer
@layout PawPal.Components.Layout.PublicLayout

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using PawPal.Data
@using PawPal.Domain

@inject PawPalContext Db
@inject UserManager<PawPalUser> UserManager
@inject NavigationManager Nav

<PageTitle>Review Application</PageTitle>

<div class="container-xl py-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div>
            <a class="text-decoration-none" href="/admin/applications">← Back to Applications</a>
            <h1 class="mb-1 mt-2" style="font-weight:800;">Review Application</h1>
            <div class="text-muted">Approve, reject, or delete this application.</div>
        </div>
        @if (App != null)
        {
            <span class="badge @StatusBadgeClass(App.Status) px-3 py-2">@App.Status</span>
        }
    </div>

    @if (Loading)
    {
        <div class="text-muted">Loading...</div>
    }
    else if (App == null || Pet == null)
    {
        <div class="alert alert-danger">Application not found.</div>
    }
    else
    {
        <div class="row g-3">
            <div class="col-12 col-lg-7">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="mb-3" style="font-weight:800;">Application Details</h5>

                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <div class="text-muted small">Pet</div>
                                <div class="fw-semibold">@Pet.Name</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="text-muted small">Applicant</div>
                                <div class="fw-semibold">@ApplicantEmail</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="text-muted small">Submitted</div>
                                <div>@App.ApplicationDate.ToString("dd MMM yyyy, h:mm tt")</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="text-muted small">Status</div>
                                <div><span class="badge @StatusBadgeClass(App.Status)">@App.Status</span></div>
                            </div>
                        </div>

                        <hr />

                        <div class="text-muted small mb-1">Applicant Notes</div>
                        <div class="border rounded p-3 bg-light">
                            @if (string.IsNullOrWhiteSpace(App.Remarks))
                            {
                                <div class="text-muted">No details provided.</div>
                            }
                            else
                            {
                                <div style="white-space:pre-wrap;">@App.Remarks</div>
                            }
                        </div>

                        <div class="mt-3">
                            <label class="form-label small text-muted">Admin Remarks (optional)</label>
                            <textarea class="form-control" rows="3" @bind="AdminRemarks"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-5">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="mb-3" style="font-weight:800;">Actions</h5>

                        @if (!string.IsNullOrEmpty(Message))
                        {
                            <div class="alert alert-info">@Message</div>
                        }
                        @if (!string.IsNullOrEmpty(Error))
                        {
                            <div class="alert alert-danger">@Error</div>
                        }

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" @onclick="ApproveAsync" disabled="@Working">
                                <i class="bi bi-check2-circle me-2"></i> Approve
                            </button>

                            <button class="btn btn-danger" @onclick="RejectAsync" disabled="@Working">
                                <i class="bi bi-x-circle me-2"></i> Reject
                            </button>

                            <button class="btn btn-outline-danger" @onclick="DeleteAsync" disabled="@Working">
                                <i class="bi bi-trash me-2"></i> Delete Application
                            </button>
                        </div>

                        <div class="text-muted small mt-3">
                            Tip: Approve means the adopter can proceed to appointment scheduling (handled by shelter/admin).
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private bool Loading = true;
    private bool Working = false;

    private AdoptionApplication? App;
    private Pet? Pet;
    private string ApplicantEmail = "(unknown)";

    private string AdminRemarks = "";
    private string? Message;
    private string? Error;

    protected override async Task OnInitializedAsync()
    {
        Loading = true;

        App = await Db.AdoptionApplication.FirstOrDefaultAsync(a => a.Id == Id);
        if (App == null)
        {
            Loading = false;
            return;
        }

        Pet = await Db.Pet.AsNoTracking().FirstOrDefaultAsync(p => p.Id == App.PetId);

        var user = await UserManager.Users.FirstOrDefaultAsync(u => u.Id == App.AdopterId);
        ApplicantEmail = user?.Email ?? "(unknown)";

        Loading = false;
    }

    private async Task ApproveAsync()
    {
        await UpdateStatusAsync("Approved");
    }

    private async Task RejectAsync()
    {
        await UpdateStatusAsync("Rejected");
    }

    private async Task UpdateStatusAsync(string newStatus)
    {
        if (App == null) return;

        Working = true;
        Error = null;
        Message = null;

        try
        {
            App.Status = newStatus;

            if (!string.IsNullOrWhiteSpace(AdminRemarks))
            {
                // Append admin remark in a clean way
                App.Remarks = (App.Remarks ?? "").Trim();
                if (!string.IsNullOrEmpty(App.Remarks)) App.Remarks += "\n\n";
                App.Remarks += $"[Admin] {AdminRemarks.Trim()}";
            }

            await Db.SaveChangesAsync();
            Message = $"Application updated to {newStatus}.";
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            Working = false;
        }
    }

    private async Task DeleteAsync()
    {
        if (App == null) return;

        Working = true;
        Error = null;
        Message = null;

        try
        {
            Db.AdoptionApplication.Remove(App);
            await Db.SaveChangesAsync();
            Nav.NavigateTo("/admin/applications", true);
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            Working = false;
        }
    }

    private string StatusBadgeClass(string? status) => (status ?? "").ToLower() switch
    {
        "pending" => "bg-warning text-dark",
        "approved" => "bg-success",
        "rejected" => "bg-danger",
        _ => "bg-secondary"
    };
}
