@page "/pets/{Id:int}"
@using PawPal.Domain
@inject PawPal.Data.PawPalContext Db
@inject NavigationManager Nav

<PageTitle>Pet Details</PageTitle>

<div class="container py-4">

    <!-- Breadcrumb / back -->
    <div class="mb-3">
        <button class="btn btn-link px-0 text-decoration-none" @onclick="Back">
            <i class="bi bi-arrow-left me-2"></i>Back to Browse
        </button>
    </div>

    @if (Pet == null)
    {
        <div class="alert alert-warning">Pet not found.</div>
    }
    else
    {
        <div class="row g-4">
            <!-- Left: main image -->
            <div class="col-12 col-lg-6">
                <img class="details-img shadow-sm"
                     src="@ImageUrl"
                     alt="Pet photo" />
            </div>

            <!-- Right: details -->
            <div class="col-12 col-lg-6">
                <div class="d-flex justify-content-between align-items-start gap-3">
                    <div>
                        <h1 class="fw-bold mb-1">@Pet.Name</h1>
                        <div class="text-muted">
                            @Pet.Species
                            @if (!string.IsNullOrWhiteSpace(Pet.Breed))
                            {
                                <span>• @Pet.Breed</span>
                            }
                            <span>• Age @Pet.Age</span>
                        </div>
                    </div>

                    <span class="badge bg-success-subtle text-success border border-success-subtle status-badge">
                        @Pet.Status
                    </span>
                </div>

                <!-- Tags -->
                <div class="mt-3 d-flex flex-wrap gap-2">
                    <span class="tag-badge"><i class="bi bi-arrows-angle-expand me-1"></i>@Pet.Size</span>
                    <span class="tag-badge"><i class="bi bi-gender-ambiguous me-1"></i>@Pet.Gender</span>
                    @if (!string.IsNullOrWhiteSpace(Pet.Temperament))
                    {
                        <span class="tag-badge"><i class="bi bi-emoji-smile me-1"></i>@Pet.Temperament</span>
                    }
                </div>

                <!-- About -->
                <div class="section-card bg-white shadow-sm p-4 mt-4">
                    <div class="fw-semibold mb-2"><i class="bi bi-info-circle me-2"></i>About</div>
                    <div class="text-muted">
                        @(!string.IsNullOrWhiteSpace(Pet.Description) ? Pet.Description : "No description provided yet.")
                    </div>
                </div>

                <!-- Medical -->
                <div class="section-card bg-light p-4 mt-3">
                    <div class="fw-semibold mb-2"><i class="bi bi-shield-check me-2"></i>Medical Info</div>
                    <div class="text-muted">
                        @(!string.IsNullOrWhiteSpace(Pet.MedicalInfo) ? Pet.MedicalInfo : "Not specified.")
                    </div>
                </div>

                <!-- CTA -->
                <div class="section-card bg-white shadow-sm p-4 mt-3">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="mini-label">Shelter</div>
                            <div class="fw-semibold">Assigned shelter</div>
                            <div class="text-muted small">We’ll show shelter details after we wire Shelter join.</div>
                        </div>
                        <div class="col-6">
                            <div class="mini-label">Status</div>
                            <div class="fw-semibold">@Pet.Status</div>
                            <div class="text-muted small">Available pets can be applied for.</div>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <a class="btn btn-success btn-lg" href="@($"/apply/{Pet.Id}")">
                            Apply to Adopt <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>

                    <div class="text-muted small text-center mt-2">
                        Please sign in to submit an application.
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    // Route parameter from /pets/{Id}
    [Parameter] public int Id { get; set; }

    // Pet loaded from DB
    private Pet? Pet;

    // Pet image (fallback if none)
    private string ImageUrl = "https://images.unsplash.com/photo-1548199973-03cce0bbc87b?auto=format&fit=crop&w=1400&q=80";

    protected override void OnParametersSet()
    {
        // Load pet by primary key (Id comes from BaseDomainModel)
        Pet = Db.Pet.FirstOrDefault(p => p.Id == Id);

        // Load first image for this pet (if exists)
        var img = Db.PetImage
            .Where(i => i.PetId == Id)
            .OrderBy(i => i.Id)
            .Select(i => i.ImageUrl)
            .FirstOrDefault();

        if (!string.IsNullOrWhiteSpace(img))
            ImageUrl = img;
    }

    private void Back() => Nav.NavigateTo("/pets");
}
